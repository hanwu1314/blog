import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,e as p}from"./app-1f4b31e2.js";const t={},e=p(`<h2 id="点赞" tabindex="-1"><a class="header-anchor" href="#点赞" aria-hidden="true">#</a> 点赞</h2><p><code>application\\home\\view\\subject\\subject\\info.html</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    <span class="token comment">// 点赞以及取消点赞</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.action&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">{:url(&#39;/home/subject/subject/like&#39;)}</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">subid</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">{$subject.id}</span><span class="token template-punctuation string">\`</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> status <span class="token operator">=</span> res<span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;取消点赞成功&#39;</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.thumbs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&#39;src&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/assets/home/images/thumbs.png&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.num&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.num&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.thumbs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&#39;src&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/assets/home/images/thumbs-up.png&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.num&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&#39;.num&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>application\\home\\controller\\subject\\Subject.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    <span class="token doc-comment comment">/**
     * 点赞
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">like</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$subid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;subid&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;trim&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询课程是否存在</span>
        <span class="token variable">$subject</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">SubjectModel</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$subid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$subject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;课程不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 分割数组</span>
        <span class="token variable">$likeArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;,&#39;</span><span class="token punctuation">,</span> <span class="token variable">$subject</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;likes&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 过滤空元素</span>
        <span class="token variable">$likeArr</span> <span class="token operator">=</span> <span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$likeArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$likeArr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$index</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$likeArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$index</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$likeArr</span><span class="token punctuation">[</span><span class="token variable">$index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;取消点赞&#39;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;无法取消点赞&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$likeArr</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;点赞&#39;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 封装更新数据</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$subid</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;likes&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;,&#39;</span><span class="token punctuation">,</span> <span class="token variable">$likeArr</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">SubjectModel</span><span class="token operator">-&gt;</span><span class="token function">isUpdate</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$msg</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token variable">$msg</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="章节序号显示" tabindex="-1"><a class="header-anchor" href="#章节序号显示" aria-hidden="true">#</a> 章节序号显示</h2><p><code>application\\home\\view\\subject\\subject\\info.html</code></p><p>第58行，给foreach添加上$key，给章节标题前添加上序号，给li表填绑定toggle方法传入id</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>{foreach($ChapterList as $key=&gt; $item)}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">&#39;{$item.id}&#39;</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-table-view-cell<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{$key+1}.{$item.title}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
{/foreach}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="点击视频判断是否购买课程" tabindex="-1"><a class="header-anchor" href="#点击视频判断是否购买课程" aria-hidden="true">#</a> 点击视频判断是否购买课程</h2><h3 id="model层" tabindex="-1"><a class="header-anchor" href="#model层" aria-hidden="true">#</a> Model层</h3><h4 id="order" tabindex="-1"><a class="header-anchor" href="#order" aria-hidden="true">#</a> order</h4><p><code>application\\common\\model\\subject\\Order.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\\</span>common<span class="token punctuation">\\</span>model<span class="token punctuation">\\</span>subject</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Order</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">//模型对应的是哪张表</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;subject_order&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//指定一个自动设置的时间字段</span>
    <span class="token comment">//开启自动写入</span>
    <span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//设置字段的名字</span>
    <span class="token keyword">protected</span> <span class="token variable">$createTime</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;createtime&quot;</span><span class="token punctuation">;</span> <span class="token comment">//插入的时候设置的字段名</span>

    <span class="token comment">//禁止 写入的时间字段</span>
    <span class="token keyword">protected</span> <span class="token variable">$updateTime</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="view层" tabindex="-1"><a class="header-anchor" href="#view层" aria-hidden="true">#</a> View层</h3><p><code>application\\home\\view\\subject\\subject\\info.html</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    <span class="token comment">// 课程id</span>
    <span class="token keyword">let</span> subid <span class="token operator">=</span> <span class="token string">&quot;{$subject.id}&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义一个章节的id</span>
    <span class="token keyword">let</span> cid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 播放器对象</span>
    <span class="token keyword">let</span> player<span class="token punctuation">;</span>

    <span class="token comment">// 点击播放</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#play&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">{:url(&#39;/home/subject/subject/play&#39;)}</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                subid<span class="token punctuation">,</span>
                cid
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>buy <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&#39;#sheet1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">popover</span><span class="token punctuation">(</span><span class="token string">&#39;toggle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">1500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controller层" tabindex="-1"><a class="header-anchor" href="#controller层" aria-hidden="true">#</a> Controller层</h3><p>添加model</p><p><code>application\\home\\controller\\subject\\Subject.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    <span class="token comment">// 课程订单模型</span>
    <span class="token keyword">protected</span> <span class="token variable">$OrderModel</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token comment">// ....</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span> <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;subject.Order&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    <span class="token doc-comment comment">/**
     * 播放
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        <span class="token variable">$subid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;subid&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;trim&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$cid</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;cid&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;trim&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$subject</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">SubjectModel</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$subid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$subject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;课程不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$OrderWhere</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;busid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;subid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$subid</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$OrderWhere</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;请先购买课程&#39;</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;buy&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;buy&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="课程购买" tabindex="-1"><a class="header-anchor" href="#课程购买" aria-hidden="true">#</a> 课程购买</h2><p>导入数据表fa_business_record.sql</p><h3 id="model层-1" tabindex="-1"><a class="header-anchor" href="#model层-1" aria-hidden="true">#</a> Model层</h3><h4 id="record" tabindex="-1"><a class="header-anchor" href="#record" aria-hidden="true">#</a> Record</h4><p><code>application\\common\\model\\business\\Record.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\\</span>common<span class="token punctuation">\\</span>model<span class="token punctuation">\\</span>business</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Record</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">//模型对应的是哪张表</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;business_record&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//指定一个自动设置的时间字段</span>
    <span class="token comment">//开启自动写入</span>
    <span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//设置字段的名字</span>
    <span class="token keyword">protected</span> <span class="token variable">$createTime</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;createtime&quot;</span><span class="token punctuation">;</span> <span class="token comment">//插入的时候设置的字段名</span>

    <span class="token comment">//禁止 写入的时间字段</span>
    <span class="token keyword">protected</span> <span class="token variable">$updateTime</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="字段验证" tabindex="-1"><a class="header-anchor" href="#字段验证" aria-hidden="true">#</a> 字段验证</h4><p><code>application\\common\\validate\\business\\Record.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\\</span>common<span class="token punctuation">\\</span>validate<span class="token punctuation">\\</span>business</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\\</span>Validate</span><span class="token punctuation">;</span>

<span class="token comment">// 用户消费记录的验证器</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Record</span> <span class="token keyword">extends</span> <span class="token class-name">Validate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span>   <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;total&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;busid&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;content&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span> 
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$message</span>  <span class="token operator">=</span>   <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;total.require&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;消费金额必填&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;busid.require&#39;</span>     <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;用户必须填写&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;content.require&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;消费描述必须填写&#39;</span><span class="token punctuation">,</span> 
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>application\\common\\validate\\subject\\Order.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\\</span>common<span class="token punctuation">\\</span>validate<span class="token punctuation">\\</span>subject</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\\</span>Validate</span><span class="token punctuation">;</span>

<span class="token comment">// 课程订单的验证器</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Order</span> <span class="token keyword">extends</span> <span class="token class-name">Validate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span>   <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;subid&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;busid&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;total&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span> 
        <span class="token string single-quoted-string">&#39;code&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;require&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;unique:subject_order&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$message</span>  <span class="token operator">=</span>   <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;subid.require&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;课程必须填写&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;busid.require&#39;</span>     <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;用户必须填写&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;total.require&#39;</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;消费金额必须填写&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;code.require&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;订单号必须填写&#39;</span><span class="token punctuation">,</span>   
        <span class="token string single-quoted-string">&#39;code.unique&#39;</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;订单号已重复&#39;</span><span class="token punctuation">,</span>   
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="videw层" tabindex="-1"><a class="header-anchor" href="#videw层" aria-hidden="true">#</a> Videw层</h3><p><code>application\\home\\view\\subject\\subject\\info.html</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#buy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&#39;#sheet1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">popover</span><span class="token punctuation">(</span><span class="token string">&#39;toggle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> btnArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;否&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;是&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        mui<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">&#39;请问您确认购买吗？&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;尊敬的用户&#39;</span><span class="token punctuation">,</span> btnArray<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">{:url(&#39;/home/subject/subject/buy&#39;)}</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
                    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        subid
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span>
                    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controller层-1" tabindex="-1"><a class="header-anchor" href="#controller层-1" aria-hidden="true">#</a> Controller层</h3><h4 id="新增用户模型与消费记录模型" tabindex="-1"><a class="header-anchor" href="#新增用户模型与消费记录模型" aria-hidden="true">#</a> 新增用户模型与消费记录模型</h4><p><code>application\\home\\controller\\subject\\Subject.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    <span class="token comment">// 用户模型</span>
    <span class="token keyword">protected</span> <span class="token variable">$BusinessModel</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 消费记录模型</span>
    <span class="token keyword">protected</span> <span class="token variable">$RecordModel</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token comment">// .....</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span> <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;Business.Business&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span> <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;Business.Record&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="添加公共方法-唯一订单号" tabindex="-1"><a class="header-anchor" href="#添加公共方法-唯一订单号" aria-hidden="true">#</a> 添加公共方法-唯一订单号</h4><p><code>application\\common.php</code></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;build_code&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 生成唯一订单号
     * <span class="token keyword">@param</span> <span class="token class-name">String</span> <span class="token parameter">$prefix</span> 指定的订单前缀
     * <span class="token keyword">@return</span> <span class="token class-name">String</span>  返回字符串
    */</span>

    <span class="token keyword">function</span> <span class="token function-definition function">build_code</span><span class="token punctuation">(</span><span class="token variable">$prefix</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        @<span class="token function">date_default_timezone_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;PRC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$order_id_main</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;YmdHis&#39;</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//订单号码主体长度</span>
        <span class="token variable">$order_id_len</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$order_id_main</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$order_id_sum</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$order_id_len</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将订单号的主体部分的每个字符提取出来，并将其转换为整数。然后，将这个整数值加到 \`$order_id_sum\` 上，用于计算订单号的校验位。</span>
            <span class="token variable">$order_id_sum</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$order_id_main</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//唯一订单号码（YYYYMMDDHHIISSNNNNNNNNCC）</span>
        <span class="token variable">$osn</span> <span class="token operator">=</span> <span class="token variable">$prefix</span><span class="token operator">.</span><span class="token variable">$order_id_main</span> <span class="token operator">.</span> <span class="token function">str_pad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> <span class="token variable">$order_id_sum</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;0&#39;</span><span class="token punctuation">,</span> <span class="token constant">STR_PAD_LEFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成唯一订单号</span>
        <span class="token keyword">return</span> <span class="token variable">$osn</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="雪花算法生成订单" tabindex="-1"><a class="header-anchor" href="#雪花算法生成订单" aria-hidden="true">#</a> 雪花算法生成订单</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>  <span class="token number">0</span>                   <span class="token number">41</span>                  <span class="token number">51</span>          <span class="token number">63</span>
  <span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------+</span>
  <span class="token operator">|</span>  <span class="token keyword">Timestamp</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>   <span class="token operator">|</span>   Machine ID <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> Sequence  <span class="token operator">|</span>
  <span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Timestamp (ms)：时间戳部分占用 41 位，用于表示生成标识符的时间戳，以毫秒为单位。这部分占据标识符的高位部分。</li><li>Machine ID (10)：机器 ID 部分占用 10 位，用于表示机器的唯一标识符，以确保在分布式环境中生成的标识符是唯一的。</li><li>Sequence：序列号部分占用 12 位，用于表示同一毫秒内生成的多个标识符的序列号，以确保在同一毫秒内生成的标识符是唯一的。这部分占据标识符的低位部分。</li></ul><p>在左移位操作中，Timestamp (ms) 部分会被左移 22 位，Machine ID (10) 部分会被左移 12 位，这样它们的位数就会对齐到标识符的相应位置。</p><p>示例演示：</p><p>假设当前时间戳为</p><ul><li>16777215（二进制为 00000000001111111111111111111111，占用 24 位）</li><li>Machine ID 为 31（二进制为 0000000000111111，占用 6 位）</li><li>Sequence 为 4095（二进制为 0000000000000000111111111111，占用 12 位）<br> 在生成标识符时，左移位操作会将 Timestamp (ms) 左移 22 位，Machine ID 左移 12 位，然后再将它们合并到一起，最终生成一个 64 位的唯一标识符。</li></ul><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token doc-comment comment">/**
 * 雪花算法
 * <span class="token keyword">@param</span> <span class="token class-name">Int</span> <span class="token parameter">$machineId</span> 指定机器码
 */</span>
<span class="token keyword">function</span> <span class="token function-definition function">generateSnowflakeId</span><span class="token punctuation">(</span><span class="token variable">$machineId</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$epoch</span> <span class="token operator">=</span> <span class="token number">1630454400000</span><span class="token punctuation">;</span> <span class="token comment">// 2021-09-01 00:00:00 UTC</span>
    <span class="token variable">$sequence</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$lastTimestamp</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回当前时间的时间戳，以毫秒为单位。</span>
    <span class="token variable">$currentTimestamp</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于计算下一个毫秒的时间戳，以确保生成的标识符在不同毫秒内是唯一的</span>
    <span class="token variable">$tilNextMillis</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$lastTimestamp</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$currentTimestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$timestamp</span> <span class="token operator">&lt;=</span> <span class="token variable">$lastTimestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$timestamp</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取当前时间戳</span>
    <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$currentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前时间戳与上一次时间戳相等,表示同一毫秒内</span>
    <span class="token comment">// 那么会根据序列号规则增加序列号，并检查序列号是否达到上限，如果达到上限会等待下一毫秒。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$timestamp</span> <span class="token operator">==</span> <span class="token variable">$lastTimestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$sequence</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$sequence</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">4095</span><span class="token punctuation">;</span> <span class="token comment">// 12 bits</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$sequence</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 等待下一个毫秒</span>
            <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$tilNextMillis</span><span class="token punctuation">(</span><span class="token variable">$lastTimestamp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$sequence</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新上一次时间戳为当前时间戳，以便下一次生成时使用。</span>
    <span class="token variable">$lastTimestamp</span> <span class="token operator">=</span> <span class="token variable">$timestamp</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 这一行计算出标识符。它将时间戳、机器ID和序列号组合成一个整数，以生成最终的唯一标识符。
     * 时间戳 41 位 + 机器 ID 10 位 + 序列号 12 位 = 63 位，再加上一个符号位（正数），总共为 64 位。
     * 时间戳部分左移 22 位，即占用了标识符的前 41 位。这是因为时间戳部分通常占用了整个 64 位标识符的最高位，
     * 从而保证生成的标识符在一段时间内是唯一的。左移 22 位是根据上述三个部分的位数来计算的
     */</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$timestamp</span> <span class="token operator">-</span> <span class="token variable">$epoch</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token variable">$machineId</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token variable">$sequence</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="购买课程" tabindex="-1"><a class="header-anchor" href="#购买课程" aria-hidden="true">#</a> 购买课程</h4><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code>    <span class="token doc-comment comment">/**
     * 购买课程
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 获取课程id</span>
        <span class="token variable">$subId</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;subid&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;trim&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断课程是否存在</span>
        <span class="token variable">$subject</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">SubjectModel</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$subId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取用户id</span>
        <span class="token variable">$busId</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$subject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;课程不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 判断当前登录用户是否购买过</span>
        <span class="token variable">$where</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;subid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$subId</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;busid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$busId</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;您已经购买过了该课程，无须重复购买&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 课程价格</span>
        <span class="token variable">$price</span> <span class="token operator">=</span> <span class="token variable">$subject</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 个人余额</span>
        <span class="token variable">$money</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;money&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断余额是否能够购买 余额-价格</span>
        <span class="token variable">$updateMoney</span> <span class="token operator">=</span> <span class="token function">bcsub</span><span class="token punctuation">(</span><span class="token variable">$money</span><span class="token punctuation">,</span> <span class="token variable">$price</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$updateMoney</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;余额不足，请先充值&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 开启事务操作</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span><span class="token operator">-&gt;</span><span class="token function">startTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">startTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span><span class="token operator">-&gt;</span><span class="token function">startTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 插入订单表</span>
        <span class="token comment">// 封装订单数据</span>
        <span class="token variable">$OrderData</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;subid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$subId</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;busid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$busId</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;total&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$price</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;code&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">generateSnowflakeId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 把数据插入数据表</span>
        <span class="token variable">$OrderStatus</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;common/subject/Order&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$OrderData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$OrderStatus</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新用户数据</span>
        <span class="token variable">$BusinessData</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;money&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$updateMoney</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 自定义一个验证器</span>
        <span class="token variable">$validate</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token comment">// 规则</span>
            <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">&#39;money&#39;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;number&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;&gt;=:0&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// 错误信息</span>
            <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">&#39;money.number&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;余额必须是数字类型&#39;</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">&#39;money.&gt;=&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;余额必须大于等于0元&#39;</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$BusinessStatus</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token variable">$validate</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">isUpdate</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$BusinessData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$BusinessStatus</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 封装用户消费记录</span>
        <span class="token variable">$RecordData</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">&#39;total&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$subject</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;busid&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">LoginBusiness</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">&#39;content&#39;</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">&quot;购买课程：【<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$subject</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;title&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>】花费了 ￥<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$subject</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span> 元&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$RecordStatus</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;common/business/Record&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token variable">$RecordData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$RecordStatus</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\\</span>Exception</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$OrderStatus</span> <span class="token operator">===</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token variable">$BusinessStatus</span> <span class="token operator">===</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token variable">$RecordStatus</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\\</span>Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;购买课程失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span><span class="token operator">-&gt;</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">OrderModel</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">BusinessModel</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">RecordModel</span><span class="token operator">-&gt;</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;购买课程成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,53),o=[e];function c(l,i){return s(),a("div",null,o)}const k=n(t,[["render",c],["__file","8点赞功能_课程购买.html.vue"]]);export{k as default};
