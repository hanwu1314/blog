---
title: ä¿®æ”¹èµ„æ–™
icon: bijiben
category: "php"
order: 5
---


## âœ¨åº•éƒ¨tabberé€‰ä¸­åˆ‡æ¢é¢œè‰²

åˆ é™¤htmlä¸­classå±æ€§`mui-active`
æ·»åŠ ä»¥ä¸‹script

`application\home\view\common\footer.html`

```html
<script>
    // è·å–åœ°å€è·¯å¾„å¹¶ä¸”è½¬ä¸ºæ•°ç»„
    let pathArr = location.pathname.split('/');
    // è¿‡æ»¤æ•°ç»„é‡Œé¢çš„å…ƒç´ 
    pathArr = pathArr.filter(val => val && val.trim())
    // æˆªå–æ•°ç»„å¹¶ä¸”è½¬æˆå­—ç¬¦ä¸²
    let path = pathArr.slice(0, 2).join('/');
    // æˆªå–æ•°ç»„å¹¶ä¸”è½¬æˆå­—ç¬¦ä¸²
    if (path == '' || path == '/') {
        $('.footer-bar .tab-item').eq(0).addClass('mui-active')
    } else if (path == 'home/business') {
        $('.footer-bar .tab-item').eq(2).addClass('mui-active')
    }
</script>
```
## âœ¨ä¿®æ”¹èµ„æ–™

`application\home\controller\Business.php`

```php
    /** ç”¨æˆ·æ¨¡å‹ */
    protected $BusinessModel = null;

    public function __construct()
    {
        parent::__construct();
        $this->BusinessModel = model('business.Business');
    }
     /**
     * ä¿®æ”¹èµ„æ–™
     */
    public function profile()
    {
        return $this->fetch();
    }
```

`application\home\view\business\index.html`å°†åŸºæœ¬èµ„æ–™aæ ‡ç­¾çš„hrefå±æ€§æ”¹ä¸º

```md
{:url('/home/business/profile')
```


`application\home\view\business\profile.html`

```html
<link rel="stylesheet" href="/assets/home/plugin/city/css/city-picker.css">
<link rel="stylesheet" href="/assets/home/css/profile.css">

<div class="user">
    <div class="avatar wow fadeInUp">
        <img src="/assets/home/images/avatar.jpg" />
    </div>
</div>

<form class="mui-input-group" method="post" enctype="multipart/form-data">
    <div class="mui-input-row">
        <label>æ˜µç§°</label>
        <input type="text" name="nickname" value="{$LoginBusiness.nickname}" class="mui-input-clear" placeholder="è¯·è¾“å…¥æ˜µç§°">
    </div>
    <div class="mui-input-row">
        <label>æ‰‹æœºå·ç </label>
        <input type="text" value="{$LoginBusiness.mobile}" disabled class="mui-input-clear" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
    </div>
    <div class="mui-input-row">
        <label>é‚®ç®±</label>
        <input type="text" name="email" value="{$LoginBusiness.email}" class="mui-input-clear" placeholder="è¯·è¾“å…¥é‚®ç®±">
    </div>
    <div class="mui-input-row">
        <label>å¯†ç </label>
        <input type="password" class="mui-input-password" placeholder="å¯†ç ä¸ºç©ºä¸ä¿®æ”¹å¯†ç ">
    </div>
    <div class="mui-input-row">
        <label>æ€§åˆ«</label>
        <select name="gender">
            <option value="0" {$LoginBusiness.gender == 0 ? 'selected' : ''}>ä¿å¯†</option>
            <option value="1" {$LoginBusiness.gender == 1 ? 'selected' : ''}>ç”·</option>
            <option value="2" {$LoginBusiness.gender == 2 ? 'selected' : ''}>å¥³</option>
        </select>
    </div>
    <div class="mui-input-row region">
        <label>åœ°åŒº</label>
        <div class="citypicker">
            <input id="city" type="text" data-toggle="city-picker" name="region" readonly />
            <!-- éšè—åŸŸ -->
            <input type="hidden" name="code" id="code">
        </div>
    </div>

    <input type="file" class="form-control" id="avatar" name="avatar" style="display: none;" />
    
    <div class="mui-button-row">
        <button type="button" class="mui-btn mui-btn-primary">ç¡®è®¤</button>
        <button type="button" class="mui-btn mui-btn-danger" onclick="history.go(-1)">è¿”å›</button>
    </div>
</form>


<script src="/assets/home/plugin/city/js/city-picker.data.min.js"></script>
<script src="/assets/home/plugin/city/js/city-picker.min.js"></script>

<script>
    // é€‰æ‹©åœ°åŒº
    $("#city").on("cp:updated", function() {
        var citypicker = $(this).data("citypicker");
        var code = citypicker.getCode("district") || citypicker.getCode("city") || citypicker.getCode("province");
        $("#code").val(code);
    });

    // é€‰æ‹©å¤´åƒ
    $('.avatar').click(function(){
        $('#avatar').click();
    });

    // æ›´æ–°å¤´åƒé¢„è§ˆ
    $('#avatar').change(function(){
        let file = $(this)[0].files[0];
        
        if(file)
        {
            let reader = new FileReader();

            reader.readAsDataURL(file);

            reader.onload = function()
            {
                $('.avatar img').attr('src',reader.result);
            }
        }
    });
</script>
```


---
## ğŸ“æ‰§è¡Œsqlè¯­å¥æ·»åŠ åœ°åŒºè¡¨

ä»ç½‘ç›˜ä¸‹è½½æ•°æ®åº“æ–‡ä»¶ï¼Œè¿è¡Œ `fa_region.sql`

```
https://pan.baidu.com/s/1n4rrc7dmZlUwmGgbHkuuyg?pwd=hw66 
```


### åˆ›å»ºåœ°åŒºæ¨¡å‹

`application\common\model\Region.php`

```php
<?php

namespace app\common\model;

use think\Model;

class Region extends Model
{
    // è¡¨å
    protected $name = 'region';
}

```
## âœ¨ä¿®æ”¹åŠŸèƒ½æµç¨‹å›¾

![](assets/05-01.webp)

## âœ¨ä¿®æ”¹èµ„æ–™åŠŸèƒ½

`application\home\controller\Business.php`

::: details

```php
    /**
     * ä¿®æ”¹èµ„æ–™
     */
    public function profile()
    {
        if ($this->request->isPost()) {
            // æ¥æ”¶è¡¨å•é‡Œçš„æ‰€æœ‰å‚æ•°
            $params = $this->request->param();

            // å°è£…æ›´æ–°æ•°æ®
            $data = [
                // è·å–ç™»å½•ç”¨æˆ·çš„idä½œä¸ºæ›´æ–°æ¡ä»¶
                'id' => $this->LoginBusiness['id'],
                'nickname' => $params['nickname'],
                'email' => $params['email'],
                'gender' => $params['gender']
            ];

            // å¦‚æœé‚®ç®±æ›´æ”¹çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦é‡æ–°è®¤è¯
            if ($params['email'] != $this->LoginBusiness['email']) {
                $data['auth'] = 0;
            }

            // å¦‚æœæ›´æ–°å¯†ç 
            if (!empty($params['password'])) {

                // éªŒè¯å¯†ç 
                if (password_verify($params['password'] . $this->LoginBusiness['salt'], $this->LoginBusiness['password'])) {
                    $this->error('æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ä¸€è‡´');
                }

                // ç”Ÿæˆå¯†ç ç›å’Œå“ˆå¸Œå¯†ç 
                $salt = build_ranstr();
                $hashedPassword = password_hash($params['password'] . $salt, PASSWORD_DEFAULT);

                // æŠŠå¤„ç†å¥½çš„å¯†ç è¿½åŠ æ›´æ–°æ•°æ®
                $data['salt'] = $salt;
                $data['password'] = $hashedPassword;
            }

            // åœ°åŒº
            if (!empty($params['code'])) {

                $path = model('Region')->where(['code' => $params['code']])->value('parentpath');
                if (empty($path)) {
                    $this->error('æ‰€é€‰åœ°åŒºä¸å­˜åœ¨');
                }

                $pathArr = explode(',', $path);

                $data['province'] = $pathArr[0] ?? null;
                $data['city'] = $pathArr[1] ?? null;
                $data['district'] = $pathArr[2] ?? null;
            }

            // å¤´åƒä¸Šä¼ 
            if (isset($_FILES['avatar']) && $_FILES['avatar']['size'] > 0) {
                $res = build_upload('avatar');

                if ($res['code'] === 0) {
                    $this->error($res['msg']);
                }

                $data['avatar'] = $res['data'];
            }

            // æ›´æ–°æ•°æ®è¡¨
            $result = $this->BusinessModel->validate('common/business/Business.profile')->isUpdate(true)->save($data);

            if ($result === false) {
                if (isset($data['avatar']) && $_FILES['avatar']['size']) {
                    @is_file(ltrim($data['avatar'], '/')) && @unlink($data['avatar'], '/');
                }

                $this->error($this->BusinessModel->getError());
            } else {
                if (isset($data['avatar']) && $_FILES['avatar']['size']) {
                    @is_file(ltrim($this->LoginBusiness['avatar'], '/')) && @unlink($this->LoginBusiness['avatar'], '/');
                }

                $this->success('æ›´æ–°æˆåŠŸ', url('/home/business/index'));
            }
        }

        return $this->fetch();
    }
```

:::

### èµ„æ–™ä¿®æ”¹é¡µé¢

å›¾ç‰‡è·¯å¾„è¯»å–å˜é‡

```php
<img src="{$LoginBusiness.avatar_cdn}" />
```

ç»™å¯†ç æ·»åŠ ä¸Šname

```html
 <input type="password" class="mui-input-password" placeholder="å¯†ç ä¸ºç©ºä¸ä¿®æ”¹å¯†ç ">
```

ç¡®è®¤æŒ‰é’®typeä»buttonæ”¹ä¸ºsubmit

```html
<button type="submit" class="mui-btn mui-btn-primary">ç¡®è®¤</button>
```

ä»å…¨å±€ä¸­è·å–çœå¸‚åŒºçš„å€¼æ›´æ–°åˆ°è¡¨å•ä¸­

```js
// è·å–çœå¸‚åŒº
let province = `{$LoginBusiness.province}`;
let city = `{$LoginBusiness.city}`;
let district = `{$LoginBusiness.district}`;
let code = district || city || province;
// æ›´æ–°åœ°åŒºçš„å€¼
$('#city').val(code);
$('#code').val(code);
```



### å•å›¾ä¸Šä¼ å·¥å…·å‡½æ•°

`application\common.php`

```php

if(!function_exists('build_upload'))
{
    /**
     * å•å›¾ä¸Šä¼ 
     * @param String $name å›¾ç‰‡åç§°
     * @return Array è¿”å›ç»“æœé›†
    */
    function build_upload($name)
    {
        $result = [
            'code' => 0,
            'msg' => 'æ²¡æœ‰å›¾ç‰‡ä¸Šä¼ ',
            'data' => null
        ];

        $file = request()->file($name);

        if($file)
        {
            // æŠŠå›¾ç‰‡ä¿å­˜æŒ‡å®šçš„ç›®å½•
            $info = $file->move(ROOT_PATH . 'public' . DS . 'uploads');

            if($info)
            {
                // ä¿®æ­£è·¯å¾„çš„æ–œæ 
                $fileName = str_replace('\\','/',$info->getSaveName());

                $result = [
                    'code' => 1,
                    'msg' => 'ä¸Šä¼ æˆåŠŸ',
                    'data' => '/uploads/' . $fileName
                ];
            }else{
                $result['msg'] = $file->getError();
            }
        }

        return $result;
    }
}
```








