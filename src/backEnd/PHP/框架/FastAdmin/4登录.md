---
title: ç™»å½•åŠŸèƒ½
icon: bijiben
category: "php"
order: 4
---


## âœ’ï¸ç™»å½•æµç¨‹å›¾

![assets/3 æ³¨å†Œ.assets/fa_business_db.png](assets/04-01.webp)


`application\home\controller\Index.php`

```php
    /**
     * ç™»å½•
     */
    public function login()
    {
        if ($this->request->isPost()) {
            $mobile = $this->request->param('mobile', '', 'trim');
            $password = $this->request->param('password', '', 'trim');

            $business = $this->BusinessModel->where(['mobile' => $mobile])->find();

            if (!$business) {
                $this->error('ç”¨æˆ·ä¸å­˜åœ¨');
            }
            if (md5($password . $business['salt']) != $business['password']) {
                $this->error('å¯†ç é”™è¯¯');
            }

            $data = [
                'id' => $business['id'],
                'mobile' => $business['mobile']
            ];
            cookie('LoginBusiness', $data);

            $this->success('ç™»å½•æˆåŠŸ', url('home/business/index'));
        }
        return $this->fetch();
    }
```

---

`application\home\view\business\index.html` å»é™¤é¦–é¡µç™»å½•æŒ‰é’®

```html
    <a href="login.html" class="login wow fadeInUp" data-wow-delay="200ms">ç™»å½•</a>
```


## âœ¨è¿½åŠ å­—æ®µä¸åŠ å¯†æ‰‹æœºå·

[è·å–å™¨ Â· ThinkPHP5.0å®Œå…¨å¼€å‘æ‰‹å†Œ Â· çœ‹äº‘ (kancloud.cn)](https://www.kancloud.cn/manual/thinkphp5/135192)

`application\common\model\business\Business.php`

```php
    /** è¿½åŠ å­—æ®µ */
    protected $append = [
        'mobile_text',
        'avatar_cdn'
    ];
    /**
     * è·å–æ‰‹æœºå·å°†å…¶åŠ å¯†
     */
    public function getMobileTextAttr($value, $data)
    {
        $mobile = $data['mobile'] ?? '';
        if (empty($mobile)) {
            return false;
        }
        return substr_replace($mobile, '****', 3, 4);
    }
```

## âœ¨åˆ›å»ºhomeå…¬å…±æ§åˆ¶å™¨

```shell
php think make:controller common/Home
```

`application\common\controller\Home.php`

```php
<?php

namespace app\common\controller;

use think\Controller;
use think\Request;

class Home extends Controller
{
    /** ä¸éœ€è¦ç™»å½•çš„æ–¹æ³• */
    protected $noNeedLogin = [];
    /** å…¨å±€ç™»å½•çš„ä¿¡æ¯ */
    protected $LoginBusiness = [];

    public function __construct()
    {
        parent::__construct();
        // è·å–å½“å‰çš„æ“ä½œå
        $action = $this->request->action();

        // åˆ¤æ–­å“ªäº›æ“ä½œåéœ€è¦è°ƒç”¨éªŒè¯ç™»å½•
        if (!in_array($action, $this->noNeedLogin) && !in_array('*', $this->noNeedLogin)) {
            $this->isLogin();
        }
    }

    /**
     * éªŒè¯ç™»å½•
     */
    protected function isLogin()
    {
        // è·å–cookie
        $LoginBusiness = cookie('LoginBusiness') ?? [];
        if (empty($LoginBusiness)) {
            $this->error('è¯·å…ˆç™»å½•', url('home/index/login'));
        }

        // ä»ç™»å½•ä¿¡æ¯è·å–ç›¸åº”çš„æ•°æ®æŸ¥è¯¢æ•°æ®è¡¨æœ‰æ²¡æœ‰è¿™ä¸ªç”¨æˆ·
        $id = $LoginBusiness['id'] ?? 0;
        $mobile = $LoginBusiness['mobile'] ?? '';

        // æŸ¥è¯¢æ•°æ®è¡¨
        $business = model('business.Business')
            ->where(['id' => $id, 'mobile' => $mobile])
            ->find();

        if (!$business) {
            // æ¸…é™¤éæ³•cookie
            cookie('LoginBusiness', null);

            $this->error('éæ³•ç™»å½•', url('/home/index/login'));
        }

        // æŸ¥è¯¢å‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯èµ‹å€¼å…¨å±€ä½¿ç”¨
        $this->LoginBusiness = $business;

        // èµ‹å€¼å…¨å±€çš„è§†å›¾
        $this->assign([
            'LoginBusiness' => $business
        ]);
    }
}

```

å°†Businessçš„çˆ¶ç±»æ”¹ä¸ºä¸Šé¢çš„Home

`application\home\controller\Business.php`

```php
use app\common\controller\Home;
class Business extends Home
{
    public function index()
    {
        return $this->fetch();
    }
}
```


ç™»å½•åå°ç®¡ç†é¢æ¿  å¸¸è§„è®¾ç½®->ç³»ç»Ÿè®¾ç½®  æ·»åŠ åŸŸåå˜é‡

![11](assets/04-02.webp)
```php
    /**
     * è·å–å¤´åƒ
     */
    public function getAvatarCdnAttr($value, $data)
    {
        $avatar = $data['avatar'] ?? '';

        if (empty($avatar)) {
            $avatar = 'assets/home/images/avatar.jpg';
        }

        // è·å–ç½‘ç«™åŸŸå
        $cdn = config('site.url');

        return $cdn . $avatar;
    }
```

`application\home\view\business\index.html`ä¿®æ”¹imgçš„è·¯å¾„

```html
<img src="{$LoginBusiness.avatar_cdn}" />
```

## âœ¨æ³¨é”€åŠŸèƒ½

`application\home\view\business\index.html` æœ€åº•éƒ¨æ·»åŠ 

```php
<script>
    $('#logout').click(() => {
        mui.confirm(
            'æ˜¯å¦ç¡®è®¤é€€å‡º',
            'é€€å‡ºæé†’',
            ['ç¡®è®¤','å–æ¶ˆ'],
            function(res)
            {
                if(res.index === 0)
                {
                    $.ajax({
                        type:'post',
                        url:`{:url('/home/index/logout')}`,
                        dataType:'json',
                        success:function(result)
                        {
                            if(result.code === 1)
                            {
                                mui.toast(result.msg);

                                $('.mui-popup-backdrop').remove()
                                $('.mui-popup').remove()

                                setInterval(() => {
                                    location.href = `{:url('/home/index/login')}`;
                                },2000);
                            }
                        }
                    });
                }
            }
        )
    })
</script>
```

`application\home\controller\Index.php`

```php
    /**
     * æ³¨é”€
     */
    public function logout()
    {
        if ($this->request->isAjax()) {
            cookie('LoginBusiness', null);
            $this->success('é€€å‡ºè´¦å·æˆåŠŸ');
        }
    }
```

## âœ¨ç™»å½•éªŒè¯

`application\home\controller\Index.php`

```php
    public function login()
    {
        // åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½• ç™»å½•åé‡å®šå‘åˆ°é¦–é¡µ
        $LoginBusiness = cookie('LoginBusiness') ?? '';
        if ($LoginBusiness) {
            $this->redirect(url('/home/business/index'));
        }
        // ....
	}
    public function register()
    {
        // åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½• ç™»å½•åé‡å®šå‘åˆ°é¦–é¡µ
        $LoginBusiness = cookie('LoginBusiness') ?? '';
        if ($LoginBusiness) {
            $this->redirect(url('/home/business/index'));
        }
        //....
    }
```

## ğŸ› ï¸ä»£ç é‡æ„ä¼˜åŒ–

1. å‡å°‘é‡å¤ä»£ç ï¼šç™»å½•å’Œæ³¨å†Œæ–¹æ³•ä¸­çš„åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½•çš„éƒ¨åˆ†å¯ä»¥æŠ½ç¦»ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•
2. å‚æ•°éªŒè¯ï¼Œåœ¨æ³¨å†Œæ–¹æ³•ä¸­ï¼Œå¯ä»¥å¯¹æ‰‹æœºå·å’Œå¯†ç è¿›è¡Œéç©ºéªŒè¯
3. æ³¨å†ŒæˆåŠŸåé‡å®šå‘é¦–é¡µæŠ½ç¦»å‡ºå‡½æ•°ï¼šæ³¨å†ŒæˆåŠŸåï¼Œå¯ä»¥ç›´æ¥é‡å®šå‘ç™»å½•é¡µé¢
4. ä½¿ç”¨å¯†ç å“ˆå¸Œå‡½æ•°ï¼šå¯ä»¥ä½¿ç”¨å¯†ç å“ˆå¸Œå‡½æ•°password_hash()æ¥è¿›è¡Œå¯†ç å“ˆå¸Œå’ŒéªŒè¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç®€å•çš„md5ã€‚

`application\home\controller\Index.php`

```php
<?php

namespace app\home\controller;

use think\Controller;

class Index extends Controller
{
    /** ç”¨æˆ·æ¨¡å‹ */
    protected $BusinessModel = null;

    public function _initialize()
    {
        $this->BusinessModel = model('business.Business');
    }

    public function index()
    {
        return $this->fetch();
    }

    /** 
     * æ³¨å†Œ
     */
    public function register()
    {
        // åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½• ç™»å½•åé‡å®šå‘åˆ°é¦–é¡µ
        if ($this->isUserLoggedIn()) {
            $this->redirectToHome();
        }

        if ($this->request->isPost()) {
            $mobile = $this->request->param('mobile', '', 'trim');
            $password = $this->request->param('password', '', 'trim');

            // éªŒè¯å‚æ•°
            if (empty($mobile) || empty($password)) {
                $this->error('æ‰‹æœºå·å’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            }

            // ç”Ÿæˆå¯†ç ç›å’Œå“ˆå¸Œå¯†ç 
            $salt = build_ranstr();
            $hashedPassword = password_hash($password . $salt, PASSWORD_DEFAULT);

            // ç»„è£…æ³¨å†Œçš„æ•°æ®
            $data = [
                'mobile' => $mobile,
                'password' => $hashedPassword,
                'salt' => $salt,
                'money' => 0,
                'auth' => 0,
                'deal' => 0,
            ];

            //  æŸ¥è¯¢ç”¨æˆ·æ¥æº
            $source = model('business.Source')->where(['name' => ['LIKE', '%äº‘è¯¾å ‚%']])->find();
            if ($source) {
                $data['sourceid'] = $source['id'];
            }

            // ä¿å­˜ç”¨æˆ·æ•°æ®
            $result = $this->registerUser($data);
            if ($result === false) {
                $this->error($this->getRegisterError());
            } else {
                $this->success('æ³¨å†ŒæˆåŠŸ', url('/home/index/login'));
            }
        }

        return $this->fetch();
    }

    /**
     * ç™»å½•
     */
    public function login()
    {
        // åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½• ç™»å½•åé‡å®šå‘åˆ°é¦–é¡µ
        if ($this->isUserLoggedIn()) {
            $this->redirectToHome();
        }

        if ($this->request->isPost()) {
            $mobile = $this->request->param('mobile', '', 'trim');
            $password = $this->request->param('password', '', 'trim');

            // æŸ¥è¯¢ç”¨æˆ·
            $user = $this->getUserByMobile($mobile);

            if (!$user) {
                $this->error('ç”¨æˆ·ä¸å­˜åœ¨');
            }
            // éªŒè¯å¯†ç 
            if (!password_verify($password . $user['salt'], $user['password'])) {
                $this->error('å¯†ç é”™è¯¯');
            }

            // è®¾ç½®ç™»å½•ä¿¡æ¯
            $data = [
                'id' => $user['id'],
                'mobile' => $user['mobile']
            ];
            cookie('LoginBusiness', $data);

            $this->success('ç™»å½•æˆåŠŸ', url('home/business/index'));
        }

        return $this->fetch();
    }

    /**
     * åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½•
     */
    private function isUserLoggedIn()
    {
        $LoginBusiness = cookie('LoginBusiness') ?? '';
        return !empty($LoginBusiness);
    }

    /**
     * é‡å®šå‘åˆ°é¦–é¡µ
     */
    private function redirectToHome()
    {
        $this->redirect(url('/home/business/index'));
    }

    /**
     * æ³¨å†Œç”¨æˆ·
     */
    private  function registerUser($data)
    {
        return $this->BusinessModel->validate('common/business/Business.register')->save($data);
    }

    /**
     * è·å–æ³¨å†Œé”™è¯¯ä¿¡æ¯
     */
    private  function getRegisterError()
    {
        return $this->BusinessModel->getError();
    }

    /**
     * æ ¹æ®æ‰‹æœºå·è·å–ç”¨æˆ·
     */
    private function getUserByMobile($mobile)
    {
        return $this->BusinessModel->where(['mobile' => $mobile])->find();
    }

    /**
     * æ³¨é”€
     */
    public function logout()
    {
        if ($this->request->isAjax()) {
            cookie('LoginBusiness', null);
            $this->success('é€€å‡ºè´¦å·æˆåŠŸ');
        }
    }
}

```
